#!/usr/bin/env ruby

require 'retest'
require 'open3'
require 'listen'

include Retest

puts "Launching Retest..."
command_to_run = ARGV.join(' ')

listener = Listen.to('.', relative: true) do |modified, added, removed|
  puts "modified absolute path: #{modified}"
  system("clear") || system("cls")

  if test_path = find_test(modified.first.strip, files: Dir.glob('**/**'))
    puts ""
    puts "Running: #{test_path}"
    puts ""
    system command_to_run.gsub('<test>', test_path)
  else
    puts "Could not find matching test to run"
  end
end
listener.start # not blocking
sleep
